<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title></title>
	<link rel="stylesheet" href="../../../public/css/bootstrap.min.css">

	<link rel="stylesheet" type="text/css" href="../../../public/layui/css/layui.css" />
	<link rel="stylesheet" type="text/css" href="../../../public/css/style.css" />

	<style type="text/css">
		.layui-border-box {
			width: 100% !important;
			margin: 0;
		}

		.layui-table-body {
			background: #FFFFFF;
		}

		.laytable-cell-1-ssqu {
			width: 80px !important;
		}

		.laytable-cell-1-230 {
			width: 100px !important;
		}

		.left_silde {
			min-height: 200px;
		}

		.menuselection {
			position: absolute;
			top: 0%;
			height: auto;
			opacity: 1;
			right: 0;
		}

		.alert-dismissible {
			padding: 20px;
			margin-bottom: 0;
			width: 100%;
		}

		.alert-dismissable .close,
		.alert-dismissible .close {
			right: 0px;
		}


		#tagInfo {
			position: absolute;
			width: 16%;
			height: 45%;
			right: 0;
			background-color: rgba(0, 0, 0, 0.24);
		}

		#tagnames p {
			line-height: 30px;
		}

		#tagInfolist p {
			color: #FFFFFF;
			line-height: 30px;
		}

		#colose {
			position: absolute;
			right: 5px;
			top: 0px;
			z-index: 99999;
		}

		#colose span {
			font-size: 26px;
			cursor: pointer;
		}

		.pluginCOnt {
			position: absolute;
			width: 3%;
			height: 6%;
			z-index: 999;
			top: 20%;
			right: 10%;
			z-index: 111;
		}

		.btn-group-vertical {
			bottom: 10%;
		}

		#alarmlist {
			margin-top: 20px;
			padding: 15px;
		}

		.alarmlist ul li {
			line-height: 40px;
			font-size: 17px;
		}

		.instrument button {
			display: inline-block !important;
			width: 100% !important;
			height: 43px;
		}

		.instrument img {
			width: 67%;
		}

		.btn-primary {
			background-color: #009688;
			border-color: #009688;
		}

		.btn-primary:hover {
			background-color: #009688;
			border-color: #009688;
		}

		.btn-primary:active,
		.btn-primary:focus {
			background-color: #009688;
			border-color: #009688;
		}

		/*.zoneApplyCont{
				position: absolute;
			    top: 38px;
			    left: -64px;
			}*/

		.upmapFile {
			width: 14%;
			height: 89px;
			position: absolute;
			top: 0;
			z-index: 9999;
			opacity: 0;
		}

		.upmap {
			width: 14%;
			border: 1px solid #666;
			padding: 12px;
		}

		.flieNmae {
			vertical-align: bottom;
			color: #666;
			font-family: -webkit-body;
			margin-left: 36px;
		}

		#preview {
			padding-left: 12%;
			box-sizing: border-box;
			margin: 10px 0;
		}

		#preview img {
			max-width: 100%;
			max-height: 100%;
		}
	</style>
</head>

<body class="clearfix">
	<div id="header">

	</div>
	<div class="content">

		<div id=" " class="min layui-col-xs12">
			<div class="left_silde layui-col-xs1">
				<ul class="layui-nav layui-nav-tree layui-inline" lay-filter="demo" style="width: 100%;">
					<li class="layui-nav-item  ">
						<a href="../area/area.html">电子围栏</a>
					</li>
					<li class="layui-nav-item ">
						<a href="../navLink/navlinkIndex.html">路线规划</a>
					</li>
					<li class="layui-nav-item ">
						<a href="../confi/index.html">基站配置</a>
					</li>
					<li class="layui-nav-item ">
						<a href="javascript:;">摄像头</a>
						<dl class="layui-nav-child">
							<dd class="">
								<a href="../camera/index.html">摄像头添加</a>
							</dd>
							<dd>
								<a href="../camera/cameralist.html">摄像头列表</a>
							</dd>

						</dl>
					</li>

					<li class="layui-nav-item  layui-nav-itemed ">
						<a href="upmap.html">地图添加</a>
					</li>
					<li class="layui-nav-item  ">
						<a href="javascript:;">协议</a>
						<dl class="layui-nav-child">
							<dd class="">
								<a href="../agreement/index.html">协议添加</a>
							</dd>
							<dd>
								<a href="../agreement/list.html">协议</a>
							</dd>
							<dd>
								<a href="../agreement/config.html">下发协议</a>
							</dd>

						</dl>
					</li>

				</ul>
			</div>

			<div id=" " class="min layui-col-xs11">
				<div class="minCont">
					<div class="listIcon formCont">
						<form class="layui-form" action="" id="fileupload">
							<div class="flist" style="margin-bottom: 3%;">
								<h3 style="color: #009688;">地图添加</h3>
							</div>
							<div class="layui-form-item">
								<div class="layui-inline">
									<label class="layui-form-label">名称：</label>
									<div class="layui-input-inline">
										<input type="text" name="mapNmae" lay-verify="required" autocomplete="off"
											class="layui-input">
									</div>
								</div>
							</div>

							<div class="layui-form-item">
								<div class="layui-inline">
									<label class="layui-form-label">minX：</label>
									<div class="layui-input-inline">
										<input type="text" name="x_min" lay-verify="required" autocomplete="off"
											class="layui-input">
									</div>
								</div>
							</div>
							<div class="layui-form-item">
								<div class="layui-inline">
									<label class="layui-form-label">maxX：</label>
									<div class="layui-input-inline">
										<input type="text" name="x_max" lay-verify="required" autocomplete="off"
											class="layui-input">
									</div>
								</div>
							</div>
							<div class="layui-form-item">
								<div class="layui-inline">
									<label class="layui-form-label">minY：</label>
									<div class="layui-input-inline">
										<input type="text" name="y_min" lay-verify="required" autocomplete="off"
											class="layui-input">
									</div>
								</div>
							</div>
							<div class="layui-form-item">
								<div class="layui-inline">
									<label class="layui-form-label">maxY：</label>
									<div class="layui-input-inline">
										<input type="text" name="y_max" lay-verify="required" autocomplete="off"
											class="layui-input">
									</div>
								</div>
							</div>
							<div class="layui-form-item">
								<div class="layui-inline">
									<label class="layui-form-label">地图：</label>
									<div class="layui-input-inline">
										<button type="button" class="layui-btn" id="test1">
											<i class="layui-icon">&#xe67c;</i>上传文件
										</button>
									</div>
									<div id="preview" class="layui-form-item"></div>
									<div class="layui-form-item">
										<button class="layui-btn" lay-submit lay-filter="upmaps"
											style="margin-left: 12%" id="submit">
											立即提交
										</button>
									</div>
								</div>
							</div>
						</form>
					</div>
				</div>
			</div>

		</div>

	</div>
	<script src=" ../../../public/js/jquery.js"></script>
	<script src=" ../../../public/layui/layui.all.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../red/js/header.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
		$(".flieNmae").hide();
		layui.use(['form', 'upload'], function () {
			var map = null;
			var fileBox = document.getElementById('preview');

			layui.upload.render({
				elem: '#test1', //绑定元素
				auto: false,
				accept: 'file',
				exts: 'fmap|png|jpg|jpeg',
				choose: function (obj) {
					obj.preview(function (index, file, result) {
						map = file;

						if (file.type.startsWith('image/')) {
							fileBox.innerText = '';
							var img = fileBox.children.length ? fileBox.children[0] : new Image();
							img.src = result;

							if (!fileBox.children.length) {
								fileBox.appendChild(img);
							}
						} else {
							fileBox.innerHTML = file.name;
						}
					});
				}
			});

			//监听提交
			var layer = layui.layer;
			layui.form.on('submit(upmaps)', function (data) {
				if (!map) {
					layer.msg('地图文件不能为空', {
						icon: 5,
						anim: 6
					});

					return false;
				}

				var formData = new FormData();
				formData.append('file', map);
				formData.append('mapName', map.name.split('.')[0] || 'map');
				fetch('/api/map/upload/mapfile', {
						method: 'POST',
						body: formData
					})
					.then(res => res.json())
					.then(res => res.resultMap.mapUrl)
					.then(url => {
						var formeInfo = data.field;
						var timestamp = Date.now();
						postAjax("/api/map/addMap", JSON.stringify({
							"createTime": timestamp,
							"createUser": "null",
							"filepath": url,
							"name": formeInfo.mapNmae,
							"updateTime": timestamp,
							"updateUser": "null",
							"xMax": formeInfo.x_max,
							"xMin": formeInfo.x_min,
							"yMax": formeInfo.y_max,
							"yMin": formeInfo.y_min
						}));
					})
					.catch(e => {
						err(e);
						complete();
					});

				return false;
			});
		});

		function postAjax(urls, data) {
			$.ajax({
				type: "post",
				url: urls,
				async: true,
				data: data,
				contentType: "application/json;charset=UTF-8",
				success: function (red) {
					if (red.success == true) {
						layer.msg('添加成功');
					} else {
						err();
					}
				},
				error: err,
				complete: complete
			});
		}

		function err(e) {
			if (e) {
				console.error(e);
			}

			layer.msg('添加失败，请重新填写');
		}

		function complete() {
			layer.close(layer.load());
			fileBox.innerHTML = '';
			map = null;
		}
	</script>

</body>

</html>