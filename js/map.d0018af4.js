(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["map"],{"09a4":function(t,e,a){t.exports={box:"History_box_28f2B","tool-bar":"History_tool-bar_3iu_9",mark:"History_mark_3NHky"}},"0a43":function(t,e,a){"use strict";var n=a("0ebb"),r=a.n(n);e["default"]=r.a},"0ebb":function(t,e,a){t.exports={box:"Monitor_box_3P_5U","tool-bar":"Monitor_tool-bar_2GPUR",tools:"Monitor_tools_iFLWy","tool-item":"Monitor_tool-item_182Qz",switch:"Monitor_switch_3ZIU_"}},1250:function(t,e,a){t.exports={box:"Census_box_3bEXU"}},1637:function(t,e,a){t.exports={box:"Zone_box_2h2Ag"}},1896:function(t,e,a){"use strict";var n=a("1250"),r=a.n(n);e["default"]=r.a},"2a87":function(t,e,a){"use strict";a.r(e);var n=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticStyle:{"padding-left":"5%","padding-top":"3%"}},[a("h3",{staticStyle:{color:"#009688"}},[t._v("\n        地图编辑\n    ")]),a("el-form",{attrs:{inline:""}},[a("el-form-item",{attrs:{label:"选择地图"}},[a("map-select",{on:{selectmap:t.selectMap}})],1),a("el-form-item",[t.permission.delete?a("el-button",{attrs:{type:"danger",icon:"el-icon-delete"},on:{click:t.del}},[t._v("\n                删除\n            ")]):t._e()],1)],1),a("div",{staticClass:"el-divider el-divider--horizontal",staticStyle:{width:"95%","background-color":"#e00"}}),t.permission.put?a("map-form",{attrs:{data:t.map},on:{submit:t.onSubmit,"update:data":function(e){t.map=e}}}):t._e()],1)},r=[],i=a("cebc"),o=(a("28a5"),a("bd86")),s=(a("aef6"),a("7f7f"),a("d225")),l=a("b0b4"),c=a("308d"),u=a("6bb5"),p=a("4e2b"),f=a("9ab4"),h=a("2fe1"),m=a("2b0e"),d=a("61fd"),g=a("b20a"),v=a("60a3"),b=function(t){function e(){var t;return Object(s["a"])(this,e),t=Object(c["a"])(this,Object(u["a"])(e).apply(this,arguments)),t.map={},t}return Object(p["a"])(e,t),Object(l["a"])(e,[{key:"selectMap",value:function(t){var e=t.margin;this.map=Object(o["a"])({id:t.id,name:t.name,minX:e[0][0],maxX:e[2][0],minY:e[0][1],maxY:e[2][1],width:e[4][0],height:e[4][1],groupCode:t.groupCode},t.filepath.endsWith(".fmap")?"filename":"url",t.filepath)}},{key:"del",value:function(){var t=this;null!=this.map.id?this.$confirm("删除地图: ".concat(this.map.name,"?")).then(function(){return t.$http.post("/api/map/deleteMap",{id:t.map.id})}).then(function(){t.$message.success("删除成功"),location.href=location.href}).catch(console.log):this.$message.error("未选择地图!")}},{key:"onSubmit",value:function(t){var e=this;if(null==this.map.id)return this.$message.error("未选择地图!");this.$confirm("确认修改?").then(function(){return t.map?e.$http.post("/api/map/upload/mapfile",{file:t.map,mapName:t.map.name.split(".")[0]||"map"}):{resultMap:{mapUrl:t.filename||t.url}}}).then(function(a){var n=Date.now(),r=t.minX,o=t.maxX,s=t.minY,l=t.maxY;return e.$http.post({url:"/api/map/addMap",body:Object(i["a"])({},e.map,{filepath:a.resultMap.mapUrl,name:t.name,updateTime:n,updateUser:"null",margin:JSON.stringify([[r,s],[r,l],[o,l],[o,s],[t.width,t.height]])}),headers:{"Content-Type":"application/json"}})}).then(function(){e.$message.success("修改成功"),e.$refs.form.reset()}).catch(console.log)}}]),e}(m["default"]);f["a"]([Object(v["c"])()],b.prototype,"permission",void 0),b=f["a"]([Object(h["b"])({components:{"map-form":d["a"],"map-select":g["a"]}})],b);var y=b,x=y,j=a("2877"),O=Object(j["a"])(x,n,r,!1,null,null,null);e["default"]=O.exports},4078:function(t,e,a){"use strict";var n=a("b669"),r=a.n(n);e["default"]=r.a},"485c":function(t,e,a){"use strict";a.r(e);var n=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{class:t.$style.box},[a("div",{class:t.$style["tool-bar"]},[a("map-select",{staticStyle:{"margin-left":"50px"},on:{selectmap:t.selectMap}})],1),a("div",{ref:"map",staticStyle:{height:"100%",overflow:"hidden"}}),a("history-control",{ref:"control",attrs:{date:t.date,showPath:t.showPath,timeRange:t.timeRange,tags:t.tags,loadCall:t.loadCall},on:{"update:date":function(e){t.date=e},"update:showPath":function(e){t.showPath=e},"update:show-path":function(e){t.showPath=e},play:t.onPlay,progress:t.onProgress,pause:t.onPause},model:{value:t.progress,callback:function(e){t.progress=e},expression:"progress"}}),t.isLoading?a("div",{staticClass:"flex-center",class:t.$style.mark},[a("i",{staticClass:"el-icon-loading"})]):t._e()],1)},r=[],i=(a("6762"),a("2fdb"),a("768b")),o=(a("ffc1"),a("96cf"),a("3b8d")),s=(a("f400"),a("ac6a"),a("5df3"),a("4f7f"),a("d225")),l=a("b0b4"),c=a("308d"),u=a("6bb5"),p=a("4e2b"),f=a("9ab4"),h=a("2fe1"),m=a("99d1"),d=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("el-card",{class:t.$style.control},[a("div",{class:t.$style.content},[a("div",{staticClass:"flex-center",class:t.$style.item,staticStyle:{"margin-right":"20px"}},[a("el-select",{staticStyle:{"min-width":"200px"},attrs:{disabled:t.isPlaying,"multiple-limit":5,multiple:"","collapse-tags":""},on:{change:t.change},model:{value:t.tagNos,callback:function(e){t.tagNos=e},expression:"tagNos"}},t._l(t.tags,function(t){return a("el-option",{key:t.id,attrs:{value:t.tagNo,label:t.name}})}),1),a("el-date-picker",{staticStyle:{margin:"0 20px"},attrs:{disabled:t.isPlaying,type:"datetimerange","value-format":"timestamp","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期"},on:{change:t.change},model:{value:t.dateProxy,callback:function(e){t.dateProxy=e},expression:"dateProxy"}}),a("el-switch",{staticStyle:{"flex-shrink":"0"},attrs:{"active-text":"显示","inactive-text":"隐藏",disabled:!t.hasData},model:{value:t.showPathProxy,callback:function(e){t.showPathProxy=e},expression:"showPathProxy"}})],1),a("div",{staticClass:"flex-center",class:t.$style.item},[a("el-button",{staticStyle:{"font-size":"24px"},attrs:{icon:t.isPlaying?"el-icon-video-pause":"el-icon-video-play",disabled:!t.canPlay,type:"text"},on:{click:t.play}}),a("el-button",{staticStyle:{"font-size":"24px"},attrs:{disabled:!t.hasData,icon:"el-icon-refresh",type:"text"},on:{click:t.rePlay}}),a("div",{staticClass:"flex-center",class:t.$style.progress},[a("span",[t._v(t._s(t._f("formatTime")(t.timeRange,t.progress)))]),a("el-slider",{staticStyle:{"flex-grow":"1",padding:"0 15px"},attrs:{disabled:!t.canPlay,"format-tooltip":t.format},on:{input:function(e){return t.$emit("progress")},change:function(e){return t.$emit("play")}},model:{value:t.progress,callback:function(e){t.progress=e},expression:"progress"}}),a("span",[t._v(t._s(t._f("formatTime")(t.timeRange,100)))])],1)],1)])])},g=[],v=a("d8c9"),b=a("2b0e"),y=a("60a3"),x=a("3c38"),j=12e5,O=function(t){function e(){var t;return Object(s["a"])(this,e),t=Object(c["a"])(this,Object(u["a"])(e).apply(this,arguments)),t.tagNos=[],t.hasData=!1,t.fragmentLength=j,t}return Object(p["a"])(e,t),Object(l["a"])(e,[{key:"destroyed",value:function(){this.controller&&this.controller.abort()}},{key:"loadData",value:function(){var t=this;if(!this.timeRange)return Promise.reject("时间范围错误");if(this.timeRange>108e5)return Promise.reject("选择的时间范围不得超过3小时");this.controller&&this.controller.abort();var e=this.index;e||(this.fragmentLength=j);var a=this.date[0]+e*this.fragmentLength,n=Math.min(a+this.fragmentLength,this.date[1]);return this.fetch(a,n).then(function(t){return e?t:x["a"].clear().then(function(){return t})}).then(function(a){return e||(t.fragmentLength=1e4*j/(a.length||1e4)),t.hasData=!0,t.syncLoad(n,e).savePosition(e,a)})}},{key:"syncLoad",value:function(t,e){var a=this;if(!(this.date&&null!=this.date[1]&&t<this.date[1]))return this;this.controller=new AbortController;for(var n=[],r=function(r){if(n.push(a.fetch(t,Math.min(t+a.fragmentLength,a.date[1]),a.controller.signal).then(function(t){a.savePosition(e+r,t),a.loadCall&&a.loadCall(a,e+r)})),t+=a.fragmentLength,t>=a.date[1])return"break"},i=1;i<=6;i++){var o=r(i);if("break"===o)break}return Promise.all(n).then(function(){return a.syncLoad(t,e+6)}).catch(console.log),this}},{key:"fetch",value:function(t,e,a){var n=6e4*(new Date).getTimezoneOffset();return this.$http.post({url:"/api/tag/queryTagHistory",body:{startTime:new Date(t-n),endTime:new Date(e-n),tagNos:this.tagNos},headers:{"Content-Type":"application/json"},signal:a}).then(function(t){var e=t.pagedData.datas;return Promise.resolve(e)})}},{key:"savePosition",value:function(){var t=Object(o["a"])(regeneratorRuntime.mark(function t(e,a){var n,r;return regeneratorRuntime.wrap(function(t){while(1)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,x["a"].getItem(e+"");case 3:return t.abrupt("return",t.sent);case 6:return t.prev=6,t.t0=t["catch"](0),n={},r=6e4*(new Date).getTimezoneOffset(),a.forEach(function(t){t.position.every(function(t){return+t>=0})&&(n[t.sTagNo]||(n[t.sTagNo]=[])).push({x:+t.position[1],y:+t.position[2],z:+t.position[3]||0,time:new Date(t.time).getTime()+r,group:t.sGroupNo})}),t.abrupt("return",x["a"].setItem(e+"",n));case 12:case"end":return t.stop()}},t,null,[[0,6]])}));function e(e,a){return t.apply(this,arguments)}return e}()},{key:"dateProxy",get:function(){return this.date||null},set:function(t){this.$emit("update:date",t)}},{key:"progress",get:function(){return this.value||0},set:function(t){this.$emit("input",t)}},{key:"canPlay",get:function(){return!!(this.tagNos.length&&this.date&&this.date.length>=2)}},{key:"index",get:function(){var t=this.progress*this.timeRange/100-j;return t<=0?0:Math.ceil(t/this.fragmentLength)}},{key:"count",get:function(){if(!this.timeRange)return 0;var t=Math.max(0,this.timeRange-j);return Math.ceil(t/this.fragmentLength)+1}}]),e}(b["default"]);f["a"]([Object(y["c"])()],O.prototype,"date",void 0),f["a"]([Object(y["c"])()],O.prototype,"timeRange",void 0),f["a"]([Object(y["c"])()],O.prototype,"value",void 0),f["a"]([Object(y["c"])()],O.prototype,"loadCall",void 0),O=f["a"]([h["b"]],O);var w=O,k=function(t){function e(){var t;return Object(s["a"])(this,e),t=Object(c["a"])(this,Object(u["a"])(e).apply(this,arguments)),t.format=null,t.isPlaying=!1,t}return Object(p["a"])(e,t),Object(l["a"])(e,[{key:"created",value:function(){var t=this;this.format=function(e){return Object(v["b"])(t.timeRange,e)}}},{key:"destroyed",value:function(){this.pause()}},{key:"change",value:function(){this.hasData=this.showPathProxy=!1,this.progress=0}},{key:"rePlay",value:function(){this.pause(),Promise.resolve().then(this.play.bind(this))}},{key:"play",value:function(){var t=this;this.isPlaying?this.pause(this.progress).$emit("pause"):this.hasData?(this.isPlaying=!0,this._play()):this.tagNos.length?(this.isPlaying=!0,this.loadData().then(this._play.bind(this)).catch(function(e){e&&t.$message.error(e),t.isPlaying=!1})):this.$message.warning("请选择标签")}},{key:"pause",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.timer&&(cancelAnimationFrame(this.timer),this.timer=void 0),this.progress=t,this.isPlaying=!1,this}},{key:"_play",value:function(){var t=this;this.timer&&(cancelAnimationFrame(this.timer),this.timer=void 0);var e=Date.now(),a=function a(){var n=Date.now();t.isPlaying&&(t.progress+=(n-e)/t.timeRange*100),t.progress>=100?t.pause():t.timer=requestAnimationFrame(a),e=n};a(),this.$emit("play")}},{key:"showPathProxy",get:function(){return this.showPath},set:function(t){this.$emit("update:showPath",t)}}]),e}(Object(h["c"])(w));f["a"]([Object(y["c"])()],k.prototype,"tags",void 0),f["a"]([Object(y["c"])()],k.prototype,"showPath",void 0),k=f["a"]([Object(h["b"])({filters:{formatTime:v["b"]}})],k);var _=k,$=_,P=a("7833"),T=(a("baf6"),a("2877"));function C(t){this["$style"]=P["default"].locals||P["default"]}var S=Object(T["a"])($,d,g,!1,C,null,null),N=S.exports,D=function(t){function e(){var t;return Object(s["a"])(this,e),t=Object(c["a"])(this,Object(u["a"])(e).apply(this,arguments)),t.date=null,t.progress=0,t.loadCall=null,t.tags=[],t.isLoading=!1,t.renderTags=new Set,t.next={},t.moving=new Set,t.fragmentIndex=-1,t.points={},t.icons=new Map,t}return Object(p["a"])(e,t),Object(l["a"])(e,[{key:"created",value:function(){var t=this;this.$http.get("/api/tag/getall",{pageSize:1e6,currentPage:1}).then(function(e){t.tags=e.pagedData.datas.map(function(e){return t.icons.set(e.tagNo,e.photo),e})}).catch(console.log),this.loadCall=function(e,a){a===t.fragmentIndex&&t.isLoading&&(t.isLoading=!1,e.play())}}},{key:"onPlay",value:function(){var t=this;this.mgr&&this.date&&this.date.length>=2&&this.getFragment().then(function(){t.mgr&&t.mgr.remove(),setTimeout(function(){t.next={},t.moving.clear(),t.renderTags.clear()},100)}).catch(console.log)}},{key:"onProgress",value:function(){var t=Object(o["a"])(regeneratorRuntime.mark(function t(){var e,a,n,r,o,s,l=this;return regeneratorRuntime.wrap(function(t){while(1)switch(t.prev=t.next){case 0:if(!(this.fragmentIndex<0)){t.next=2;break}return t.abrupt("return");case 2:return e=this.fragmentIndex,a=this.points,t.prev=4,t.next=7,this.getFragment();case 7:t.next=12;break;case 9:return t.prev=9,t.t0=t["catch"](4),t.abrupt("return",console.log(t.t0));case 12:n=function(){var t=Object(i["a"])(o[r],2),n=t[0],s=t[1];if(l.moving.has(n))return"continue";Promise.resolve().then(function(){return l.mgr?l.parseProgress(s,e,a[n]||[],n):Promise.reject("地图不存在")}).then(function(t){var e=t.prev,a=t.target,r=t.record;if(!l.groups.includes(a.group))return l.mgr&&(l.mgr.remove(n),l.mgr.lineMgr.remove(n)),l.renderTags.delete(n);if(e&&l.renderTags.has(n)){var i=a.time-e.time+r.errorTime;l.moveTo(n,a,i).then(function(){return l.moving.delete(n)}),l.moving.add(n),r.index++,l.next[n]=r}else l.start(a,n)}).catch(console.log)},r=0,o=Object.entries(this.points);case 14:if(!(r<o.length)){t.next=21;break}if(s=n(),"continue"!==s){t.next=18;break}return t.abrupt("continue",18);case 18:r++,t.next=14;break;case 21:case"end":return t.stop()}},t,this,[[4,9]])}));function e(){return t.apply(this,arguments)}return e}()},{key:"onPause",value:function(){this.mgr&&this.mgr.stopMoveTo()}},{key:"parseProgress",value:function(){var t=Object(o["a"])(regeneratorRuntime.mark(function t(e,a,n,r){var i,o,s,l;return regeneratorRuntime.wrap(function(t){while(1)switch(t.prev=t.next){case 0:if(i=this.next[r]||{index:0,errorTime:0},a===this.fragmentIndex?(o=e[i.index],s=e[i.index-1]):(o=e[0],s=n?n.pop():null),o){t.next=18;break}if(e.length&&!(this.$refs.control.count<=this.fragmentIndex+1)){t.next=8;break}return this.mgr&&this.mgr.remove(r),t.abrupt("return",Promise.reject());case 8:return t.prev=8,t.next=11,x["a"].getItem(this.fragmentIndex+1+"");case 11:return l=t.sent,t.abrupt("return",this.parseProgress(l[r]||[],a,n,r));case 15:return t.prev=15,t.t0=t["catch"](8),t.abrupt("return",this.loading());case 18:return t.abrupt("return",{target:o,prev:s,record:i});case 19:case"end":return t.stop()}},t,this,[[8,15]])}));function e(e,a,n,r){return t.apply(this,arguments)}return e}()},{key:"start",value:function(t,e){if(this.mgr&&this.date&&this.date.length>=2){var a=this.timeRange*this.progress/100,n=t.time-this.date[0];a>=n&&(this.mgr.addImage({x:t.x,y:t.y,height:.5,url:this.icons.get(e),size:48},e,void 0,!1),this.renderTags.add(e),this.next[e]={index:1,errorTime:0})}}},{key:"getFragment",value:function(){var t=this;return Promise.resolve().then(function(){var e=t.$refs.control.index;return e!==t.fragmentIndex?(t.fragmentIndex=e,x["a"].getItem(e+"")):t.points}).then(function(e){return t.points=e}).catch(this.loading.bind(this))}},{key:"loading",value:function(){return this.isLoading=!0,this.$refs.control.pause(),Promise.reject("loading...")}},{key:"timeRange",get:function(){return!this.date||this.date.length<2?0:this.date[1]-this.date[0]}}]),e}(Object(h["c"])(m["a"]));D=f["a"]([Object(h["b"])({components:{"history-control":N}})],D);var M=D,z=M,R=a("e87d");function I(t){this["$style"]=R["default"].locals||R["default"]}var A=Object(T["a"])(z,n,r,!1,I,null,null);e["default"]=A.exports},"5eed":function(t,e,a){"use strict";a.r(e);var n=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticStyle:{"padding-left":"5%","padding-top":"3%"}},[t._m(0),a("map-form",{ref:"form",on:{submit:t.onSubmit}})],1)},r=[function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("h3",{staticStyle:{color:"#009688"}},[t._v("\n        地图添加\n        "),a("span",{staticStyle:{"font-size":"12px"}},[t._v('\n            (注意: 如果地图文件是fengmap文件, 需将其对应的主题文件夹放入\n            "/data/theme/" 目录)\n        ')])])}],i=(a("7f7f"),a("28a5"),a("d225")),o=a("b0b4"),s=a("308d"),l=a("6bb5"),c=a("4e2b"),u=a("9ab4"),p=a("2fe1"),f=a("2b0e"),h=a("61fd"),m=function(t){function e(){return Object(i["a"])(this,e),Object(s["a"])(this,Object(l["a"])(e).apply(this,arguments))}return Object(c["a"])(e,t),Object(o["a"])(e,[{key:"onSubmit",value:function(t){var e=this;this.$http.post("/api/map/upload/mapfile",{file:t.map,mapName:t.map.name.split(".")[0]||"map"}).then(function(a){var n=Date.now(),r=t.minX,i=t.maxX,o=t.minY,s=t.maxY;return e.$http.post({url:"/api/map/addMap",body:{createTime:n,createUser:"null",filepath:a.resultMap.mapUrl,name:t.name,updateTime:n,updateUser:"null",margin:JSON.stringify([[r,o],[r,s],[i,s],[i,o],[t.width,t.height]])},headers:{"Content-Type":"application/json"}})}).then(function(){e.$message.success("添加成功"),e.$refs.form.reset()}).catch(console.log)}}]),e}(f["default"]);m=u["a"]([Object(p["b"])({components:{"map-form":h["a"]}})],m);var d=m,g=d,v=a("2877"),b=Object(v["a"])(g,n,r,!1,null,null,null);e["default"]=b.exports},"61fd":function(t,e,a){"use strict";var n=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("el-form",{ref:"form",attrs:{"label-width":"auto",model:t.form}},[a("el-form-item",{attrs:{label:"地图名称",prop:"name",required:""}},[a("el-input",{staticStyle:{width:"50%"},attrs:{placeholder:"请输入地图名称"},model:{value:t.form.name,callback:function(e){t.$set(t.form,"name",e)},expression:"form.name"}})],1),t._l(["minX","maxX","minY","maxY"],function(e){return a("el-form-item",{key:e,attrs:{label:e,prop:e,required:""}},[a("el-input-number",{attrs:{step:100,placeholder:"地图坐标"},model:{value:t.form[e],callback:function(a){t.$set(t.form,e,a)},expression:"form[k]"}})],1)}),a("el-form-item",{attrs:{label:"地图大小",required:""}},[a("el-form-item",{class:t.$style.inline,attrs:{required:"",prop:"width"}},[a("el-input-number",{attrs:{step:100,placeholder:"宽(实际)"},model:{value:t.form.width,callback:function(e){t.$set(t.form,"width",e)},expression:"form.width"}})],1),a("el-form-item",{class:t.$style.inline,staticStyle:{"margin-left":"20px"},attrs:{required:"",prop:"height"}},[a("el-input-number",{attrs:{step:100,placeholder:"高(实际)"},model:{value:t.form.height,callback:function(e){t.$set(t.form,"height",e)},expression:"form.height"}})],1)],1),a("el-form-item",{attrs:{label:"关联分组",prop:"groupCode",required:""}},[a("el-select",{staticClass:"select_input",attrs:{multiple:"",filterable:"","allow-create":"",clearable:"","default-first-option":"",placeholder:"关联分组","popper-class":t.$style.hidden},model:{value:t.form.groupCode,callback:function(e){t.$set(t.form,"groupCode",e)},expression:"form.groupCode"}})],1),a("el-form-item",{attrs:{required:"",label:"地图"}},[a("el-upload",{attrs:{"auto-upload":!1,action:"","show-file-list":!1,"on-change":t.changeUpload}},[a("el-button",{attrs:{size:"small",type:"success",icon:"el-icon-upload"}},[t._v("\n                选择文件\n            ")]),a("div",{staticClass:"el-upload__tip",attrs:{slot:"tip"},slot:"tip"},[t.form.url?a("img",{class:t.$style.img,attrs:{src:t.form.url}}):[t._v("\n                    "+t._s(t.form.filename||"只能上传jpg/png/fmp文件，且不超过5M")+"\n                ")]],2)],1)],1),a("el-form-item",[a("el-button",{attrs:{type:"success"},on:{click:t.submit}},[t._v("立即提交")])],1)],2)},r=[],i=a("cebc"),o=(a("7f7f"),a("aef6"),a("d225")),s=a("b0b4"),l=a("308d"),c=a("6bb5"),u=a("4e2b"),p=a("9ab4"),f=a("2b0e"),h=a("2fe1"),m=a("60a3"),d=function(t){function e(){var t;return Object(o["a"])(this,e),t=Object(l["a"])(this,Object(c["a"])(e).apply(this,arguments)),t.form={url:"",filename:"",map:null,name:"",groupCode:[]},t.changeUpload=null,t}return Object(u["a"])(e,t),Object(s["a"])(e,[{key:"created",value:function(){var t=this;this.changeUpload=function(e){if("image/png"!==e.raw.type&&"image/jpeg"!==e.raw.type&&!e.name.endsWith(".fmap"))return t.$message.error("只能上传jpg/png/fmag文件!");if(e.size/1024/1024>5)return t.$message.error("上传文件大小不能超过 5MB!");if(e.name.endsWith(".fmap"))t.form.url="",t.form.filename=e.name;else{var a=new FileReader;a.onload=function(e){t.form.filename="",t.form.url=e.target.result},a.readAsDataURL(e.raw)}t.form.map=e.raw}}},{key:"submit",value:function(){var t=this,e=this.$refs.form;e.validate().then(function(){if(!(t.form.map||t.form.url||t.form.filename))return t.$message.warning("地图文件不能为空");var e=Object(i["a"])({},t.form,{groupCode:t.form.groupCode.join(",")});t.$emit("update:data",e),t.$emit("submit",e)}).catch(console.log)}},{key:"reset",value:function(){return this.$refs.form.resetFields(),this.form.map=null,this.form.url=this.form.filename="",{}}},{key:"assignForm",value:function(){Object.assign(this.form,this.data)}}]),e}(f["default"]);p["a"]([Object(m["c"])({default:function(){return{}}})],d.prototype,"data",void 0),p["a"]([Object(m["b"])("update:data")],d.prototype,"reset",null),p["a"]([Object(m["d"])("data")],d.prototype,"assignForm",null),d=p["a"]([h["b"]],d);var g=d,v=g,b=a("4078"),y=(a("ded2"),a("2877"));function x(t){this["$style"]=b["default"].locals||b["default"]}var j=Object(y["a"])(v,n,r,!1,x,null,null);e["a"]=j.exports},"69b2":function(t,e,a){},"6b39":function(t,e,a){},7833:function(t,e,a){"use strict";var n=a("8a47"),r=a.n(n);e["default"]=r.a},8615:function(t,e,a){var n=a("5ca1"),r=a("504c")(!1);n(n.S,"Object",{values:function(t){return r(t)}})},"89b9":function(t,e,a){"use strict";a.r(e);var n=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{class:t.$style.box,on:{click:t.hiddenCover}},[a("div",{staticClass:"flex-center",class:t.$style["tool-bar"]},[a("map-select",{on:{selectmap:t.selectMap}}),a("el-input",{staticStyle:{width:"200px"},attrs:{placeholder:"请输入标签号",type:"search"},model:{value:t.findTarget,callback:function(e){t.findTarget=e},expression:"findTarget"}},[a("el-button",{attrs:{slot:"append",icon:"el-icon-search"},on:{click:t.find},slot:"append"})],1)],1),a("el-switch",{class:t.$style.switch,attrs:{"active-text":"显示轨迹","inactive-text":"隐藏轨迹","active-color":"#13ce66","inactive-color":"#ff4949"},model:{value:t.showPath,callback:function(e){t.showPath=e},expression:"showPath"}}),a("div",{ref:"map",staticStyle:{height:"100%",overflow:"hidden"}}),a("div",{class:t.$style.tools},t._l(t.tools,function(e,n){return a("el-button",{directives:[{name:"show",rawName:"v-show",value:e.display,expression:"v.display"}],key:n,class:t.$style["tool-item"],attrs:{type:e.active?"primary":""},on:{click:function(e){return e.stopPropagation(),t.swithDisplay(n)}}},[t._v("\n            "+t._s(e.name)+"\n        ")])}),1),a("transition",{attrs:{name:"el-zoom-in-bottom"}},[t.tools[4].active?a("Census",{attrs:{tags:t.tagAll,zones:t.zoneAll,renderTags:t.renderTags},on:{close:function(e){t.tools[4].active=!1}}}):t._e()],1),a("transition",{attrs:{name:"el-fade-in-linear"}},[t.tools[3].active?a("Group",{attrs:{group:t.groupData}}):t._e(),t.tools[2].active?a("Zone",{attrs:{zones:t.zoneAll}}):t._e()],1)],1)},r=[],i=a("cebc"),o=(a("4917"),a("7f7f"),a("75fc")),s=a("768b"),l=(a("ac4d"),a("8a81"),a("7514"),a("8615"),a("96cf"),a("3b8d")),c=(a("ac6a"),a("5df3"),a("f400"),a("d225")),u=a("b0b4"),p=a("308d"),f=a("6bb5"),h=a("4e2b"),m=a("9ab4"),d=a("2fe1"),g=a("99d1"),v=a("d8c9"),b=a("b3af"),y=a("ae85"),x=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{on:{click:function(t){t.stopPropagation()}}},[a("el-card",{ref:"table",staticClass:"card",class:t.$style.box},[a("app-table",{attrs:{"max-height":500,"table-data":t.tableData,"col-cfg":t.colCfg,"total-count":t.totalCount,op:[{type:"danger",name:"switch",desc:"切换显示"}],isSmall:!0,noPrint:!0},on:{switch:t.switchZone,updateData:t.getData}})],1)],1)},j=[],O=(a("d185"),a("4f7f"),a("60a3")),w=new Set,k=function(t){function e(){var t;return Object(c["a"])(this,e),t=Object(p["a"])(this,Object(f["a"])(e).apply(this,arguments)),t.colCfg=[{prop:"name",label:"区域"},{prop:"status",label:"状态"}],t}return Object(h["a"])(e,t),Object(u["a"])(e,[{key:"switchZone",value:function(t){if(this.$parent){var e=Reflect.get(this.$parent,"mgr");e&&(w.has(t.name)?(e.remove(t.name),w.delete(t.name)):(e.zoneOpen(t),w.add(t.name)))}}},{key:"fetch",value:function(){var t=Object(l["a"])(regeneratorRuntime.mark(function t(e,a){var n;return regeneratorRuntime.wrap(function(t){while(1)switch(t.prev=t.next){case 0:return n=this.zones.slice((e-1)*a,e*a),t.abrupt("return",{count:this.zones.length,data:n.map(function(t){var e=Object(i["a"])({},t);return e.status=t.enable?"开启":"关闭",e.position="string"===typeof t.position?JSON.parse(t.position):t.position,e})});case 2:case"end":return t.stop()}},t,this)}));function e(e,a){return t.apply(this,arguments)}return e}()}]),e}(Object(d["c"])(y["a"]));m["a"]([Object(O["c"])()],k.prototype,"zones",void 0),k=m["a"]([d["b"]],k);var _=k,$=_,P=a("fcc3"),T=a("2877");function C(t){this["$style"]=P["default"].locals||P["default"]}var S=Object(T["a"])($,x,j,!1,C,null,null),N=S.exports,D=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{on:{click:function(t){t.stopPropagation()}}},[a("el-card",{ref:"table",staticClass:"card",class:t.$style.box},[a("app-table",{attrs:{"max-height":500,"table-data":t.tableData,"col-cfg":t.colCfg,"total-count":t.totalCount,op:[{type:"danger",name:"switch",desc:"切换显示"}],isSmall:!0,noPrint:!0},on:{switch:t.switchZone,updateData:t.getData}})],1)],1)},M=[],z=(a("ffc1"),function(t){function e(){var t;return Object(c["a"])(this,e),t=Object(p["a"])(this,Object(f["a"])(e).apply(this,arguments)),t.colCfg=[{prop:"id",label:"分组"}],t}return Object(h["a"])(e,t),Object(u["a"])(e,[{key:"switchZone",value:function(t){if(this.$parent){var e=Reflect.get(this.$parent,"mgr");e&&t.children.forEach(function(t){return e.show(t.baseNo)})}}},{key:"fetch",value:function(){var t=Object(l["a"])(regeneratorRuntime.mark(function t(e,a){var n;return regeneratorRuntime.wrap(function(t){while(1)switch(t.prev=t.next){case 0:return n=Object.entries(this.group).slice((e-1)*a,e*a),t.abrupt("return",{count:n.length,data:n.map(function(t){return{id:t[0],children:t[1]}})});case 2:case"end":return t.stop()}},t,this)}));function e(e,a){return t.apply(this,arguments)}return e}()}]),e}(Object(d["c"])(y["a"])));m["a"]([Object(O["c"])()],z.prototype,"group",void 0),z=m["a"]([d["b"]],z);var R=z,I=R,A=a("932b");function E(t){this["$style"]=A["default"].locals||A["default"]}var L=Object(T["a"])(I,D,M,!1,E,null,null),U=L.exports,F=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{on:{click:function(t){t.stopPropagation()}}},[a("el-card",{class:t.$style.box},[a("div",{attrs:{slot:"header"},slot:"header"},[a("span",[t._v("标签统计")]),a("el-button",{staticStyle:{float:"right",padding:"3px 0"},attrs:{type:"text",icon:"el-icon-close"},on:{click:function(e){return t.$emit("close")}}})],1),a("el-form",{staticStyle:{margin:"0 auto 44px"}},[a("el-form-item",{attrs:{label:"选择区域"}},[a("el-select",{attrs:{filterable:""},model:{value:t.value,callback:function(e){t.value=e},expression:"value"}},[a("el-option",{attrs:{label:"当前地图",value:-1}}),t._l(t.zones,function(t){return a("el-option",{key:t.id,attrs:{label:t.name,value:t.id}})})],2)],1)],1),t.info?a("div",{staticStyle:{"border-bottom":"1px solid #ccc","text-align":"center"}},[t._v("\n            "+t._s(t.info.name)+"标签数量: "+t._s(t.info.count)+"\n        ")]):t._e()],1)],1)},W=[],q=(a("aef6"),a("456d"),a("2b0e")),X=function(t){function e(){var t;return Object(c["a"])(this,e),t=Object(p["a"])(this,Object(f["a"])(e).apply(this,arguments)),t.value=-1,t}return Object(h["a"])(e,t),Object(u["a"])(e,[{key:"info",get:function(){var t=this;if(this.tags&&this.zones&&this.renderTags){var e=Object.keys(this.renderTags);if(-1===this.value)return{name:"当前地图",count:e.length};var a=this.zones.find(function(e){return e.id===t.value});if(a){var n=e.filter(function(e){return+t.tags[e].zone===t.value});return{name:a.name+(a.name.endsWith("区域")?"":"区域"),count:n.length}}}return null}}]),e}(q["default"]);m["a"]([Object(O["c"])()],X.prototype,"tags",void 0),m["a"]([Object(O["c"])()],X.prototype,"zones",void 0),m["a"]([Object(O["c"])()],X.prototype,"renderTags",void 0),X=m["a"]([d["b"]],X);var H=X,Y=H,Z=a("1896");function J(t){this["$style"]=Z["default"].locals||Z["default"]}var G=Object(T["a"])(Y,F,W,!1,J,null,null),B=G.exports,K=a("c860"),Q=function(t){function e(){var t;return Object(c["a"])(this,e),t=Object(p["a"])(this,Object(f["a"])(e).apply(this,arguments)),t.groupData={},t.tools=[{name:"2D",active:!0,display:!0},{name:"3D",active:!1,display:!1},{name:"区域列表",active:!1,display:!0},{name:"分组列表",active:!1,display:!0},{name:"统计",active:!1,display:!0}],t.zoneAll=[],t.findTarget="",t.showPath=!1,t.renderTags={},t.baseAll=[],t.tagAll={},t.ws=[],t.pops=new Map,t}return Object(h["a"])(e,t),Object(u["a"])(e,[{key:"created",value:function(){var t=this;Promise.all(["tag","zone"].map(function(){var e=Object(l["a"])(regeneratorRuntime.mark(function e(a){var n;return regeneratorRuntime.wrap(function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.$http.get("/api/".concat(a,"/getall"),{currentPage:1,pageSize:1e8});case 3:return n=e.sent,e.abrupt("return",n.pagedData.datas);case 7:return e.prev=7,e.t0=e["catch"](0),e.abrupt("return",[]);case 10:case"end":return e.stop()}},e,null,[[0,7]])}));return function(t){return e.apply(this,arguments)}}())).then(function(e){t.zoneAll=e[1],t.tagAll=Object(v["a"])(e[0],"tagNo",!1)})}},{key:"beforeDestroy",value:function(){var t=this.ws.pop();while(t)t.close(),t.onmessage=null,t=this.ws.pop();Object.values(this.renderTags).forEach(clearTimeout)}},{key:"swithDisplay",value:function(t){var e=this.tools[t];if(t<2){if(e.active)return;var a=this.tools[t?0:1];a.active=!a.active,this.mgr&&this.mgr.switchViewMode()}if(e.active=!e.active,2===t||3===t){var n=this.tools[2===t?3:2];e.active&&(n.active=!1)}}},{key:"hiddenCover",value:function(){for(var t=2;t<this.tools.length;t++)this.tools[t].active=!1}},{key:"find",value:function(){var t=this;if(!this.findTarget)return this.$message.warning("请输入标签号");if(this.mgr&&!this.pops.has(this.findTarget)){var e=this.mgr.find(this.findTarget);e.length?this.pops.set(this.findTarget,e.map(function(e){return t.mgr.addPopInfo(e)})[0]):this.$message.info("未找到标签号为".concat(this.findTarget,"的标签"))}this.findTarget=""}},{key:"bindEvents",value:function(){var t=this;this.mgr.on("loadComplete",function(){t.mgr&&(t.tools[1].display=t.mgr.has3D,t.tagAnchor().then(function(e){t.baseAll=e,t.groupData=Object(v["a"])(e,"groupCode"),t.initWebSoket()}))}),this.mgr.on("mapClickNode",function(e){if(t.mgr)if(e.nodeType===fengmap.FMNodeType.IMAGE_MARKER&&e.target.custom&&e.target.custom.info.tagNo){var a=e.target.custom.info.tagNo;t.pops.has(a)||t.pops.set(a,t.mgr.addPopInfo(e.target))}else{var n=!0,r=!1,i=void 0;try{for(var o,l=t.pops.entries()[Symbol.iterator]();!(n=(o=l.next()).done);n=!0){var c=Object(s["a"])(o.value,2),u=c[0],p=c[1];p.close()&&t.pops.delete(u)}}catch(f){r=!0,i=f}finally{try{n||null==l.return||l.return()}finally{if(r)throw i}}}})}},{key:"tagAnchor",value:function(){var t=Object(l["a"])(regeneratorRuntime.mark(function t(){var e,a,n,r,i,s,l,c;return regeneratorRuntime.wrap(function(t){while(1)switch(t.prev=t.next){case 0:if(t.prev=0,e=Object(o["a"])(this.baseAll),e.length){t.next=7;break}return t.next=5,this.$http.get("/api/base/getall",{currentPage:1,pageSize:1e4});case 5:a=t.sent,e=a.pagedData.datas;case 7:if(!this.mgr){t.next=27;break}for(n=!0,r=!1,i=void 0,t.prev=11,s=e[Symbol.iterator]();!(n=(l=s.next()).done);n=!0)c=l.value,this.addIcon(1,{x:c.coordx,y:c.coordy,name:c.baseNo,groupid:c.groupCode,photo:"/images/anchor.png",size:32},2),this.mgr.addTextMarker({height:2,fillcolor:"#009688",fontsize:15,type:1,strokecolor:"255,255,0",x:c.coordx,y:c.coordy-40},c.baseNo+"");t.next=19;break;case 15:t.prev=15,t.t0=t["catch"](11),r=!0,i=t.t0;case 19:t.prev=19,t.prev=20,n||null==s.return||s.return();case 22:if(t.prev=22,!r){t.next=25;break}throw i;case 25:return t.finish(22);case 26:return t.finish(19);case 27:return t.abrupt("return",e);case 30:return t.prev=30,t.t1=t["catch"](0),t.abrupt("return",[]);case 33:case"end":return t.stop()}},t,this,[[0,30],[11,15,19,27],[20,,22,26]])}));function e(){return t.apply(this,arguments)}return e}()},{key:"addIcon",value:function(t,e){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;if(this.mgr){var n=this.mgr.map;return this.mgr instanceof K["a"]&&(n.gestureEnableController.enableMapHover=!0),this.mgr.addImage({x:e.x,y:e.y,height:.5,url:e.photo,size:e.size||48,callback:function(t){t.custom||(t.custom={}),Object.assign(t.custom,{type:a,info:e}),e.callback&&e.callback(t)}},e.name,t,!!e.isMapCoor)}}},{key:"initWebSoket",value:function(){var t=this,e=location.hostname,a=Date.now();this.ws=this.groups.map(function(n){var r=new WebSocket("ws://".concat(e,"/realtime/position/").concat(n,"/").concat(a));return r.onmessage=function(e){var a=JSON.parse(e.data);t.tagAll[a.sTagNo]&&t.move(a)},r})}},{key:"move",value:function(t){var e=this;if(!this.mgr)return console.log("获取地图失败!!");if(t.position.every(function(t){return+t>=0})){var a=this.renderTags[t.sTagNo],n={x:+t.position[0],y:+t.position[1],z:0};if(a)clearTimeout(a),this.mgr.show(t.sTagNo,!0),this.moveTo(t.sTagNo,n,1,function(){var a=e.pops.get(t.sTagNo);a&&a.update&&a.update()});else{var r=this.tagAll[t.sTagNo],o=Object(i["a"])({},r||{},{name:t.sTagNo,tagName:r?r.name:"未知标签"},n),s=this.mgr.map.groupIDs;this.addIcon(s?s[0]:0,o)}this.renderTags[t.sTagNo]=setTimeout(function(){e.$notify.warning("标签".concat(t.sTagNo,"异常。\n信号丢失!")),e.mgr&&(e.mgr.show(t.sTagNo,!1),e.pops.has(t.sTagNo)&&(e.pops.get(t.sTagNo).close(!0),e.pops.delete(t.sTagNo)))},b["f"])}}}]),e}(Object(d["c"])(g["a"],y["a"]));Q=m["a"]([Object(d["b"])({components:{Zone:N,Group:U,Census:B}})],Q);var V=Q,tt=V,et=a("0a43");function at(t){this["$style"]=et["default"].locals||et["default"]}var nt=Object(T["a"])(tt,n,r,!1,at,null,null);e["default"]=nt.exports},"8a47":function(t,e,a){t.exports={control:"Control_control_-Xm__",content:"Control_content_8jrU1",progress:"Control_progress_3Owql",item:"Control_item_3l-J0"}},"932b":function(t,e,a){"use strict";var n=a("c055"),r=a.n(n);e["default"]=r.a},a89f:function(t,e,a){"use strict";a.r(e);var n=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",[a("div",{staticClass:"main"},[a("div",{staticStyle:{"overflow-y":"auto"},style:{height:t.mainHeight}},[a("router-view")],1)]),a("app-aside",{attrs:{tabs:t.tabs}})],1)},r=[],i=a("d225"),o=a("308d"),s=a("6bb5"),l=a("4e2b"),c=a("9ab4"),u=a("2fe1"),p=a("3d13"),f=a("cda1"),h=a("2b0e"),m=function(t){function e(){var t;return Object(i["a"])(this,e),t=Object(o["a"])(this,Object(s["a"])(e).apply(this,arguments)),t.tabs=[{title:"实时监控",to:"/monitor",icon:"el-icon-view"},{title:"历史轨迹",to:"/monitor/history",icon:"el-icon-film"},{title:"地图编辑",to:"/monitor/edit",icon:"el-icon-edit"},{title:"地图添加",to:"/monitor/add",icon:"el-icon-document-add"}],t}return Object(l["a"])(e,t),e}(h["default"]);c["a"]([Object(f["a"])("mainHeight")],m.prototype,"mainHeight",void 0),m=c["a"]([Object(u["b"])({components:{"app-aside":p["a"]}})],m);var d=m,g=d,v=a("2877"),b=Object(v["a"])(g,n,r,!1,null,null,null);e["default"]=b.exports},aef6:function(t,e,a){"use strict";var n=a("5ca1"),r=a("9def"),i=a("d2c8"),o="endsWith",s=""[o];n(n.P+n.F*a("5147")(o),"String",{endsWith:function(t){var e=i(this,t,o),a=arguments.length>1?arguments[1]:void 0,n=r(e.length),l=void 0===a?n:Math.min(r(a),n),c=String(t);return s?s.call(e,c,l):e.slice(l-c.length,l)===c}})},b669:function(t,e,a){t.exports={img:"MapEdit_img_1sgW2",inline:"MapEdit_inline_2M2U8",hidden:"MapEdit_hidden_3KdCb"}},baf6:function(t,e,a){"use strict";var n=a("69b2"),r=a.n(n);r.a},c055:function(t,e,a){t.exports={box:"Group_box_MIaUk"}},ded2:function(t,e,a){"use strict";var n=a("6b39"),r=a.n(n);r.a},e87d:function(t,e,a){"use strict";var n=a("09a4"),r=a.n(n);e["default"]=r.a},fcc3:function(t,e,a){"use strict";var n=a("1637"),r=a.n(n);e["default"]=r.a}}]);
//# sourceMappingURL=map.d0018af4.js.map